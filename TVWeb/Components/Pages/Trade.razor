@page "/trade"
@using TVWeb.Models
@using TVWeb.Services
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@inject PositionsStore Store
@implements IDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Trade Room</PageTitle>

<div class="container-fluid mt-3">
    <div class="trade-header shadow-sm mb-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h3 class="mb-0">Live Positions</h3>
                <p class="text-muted mb-0">Total: @Store.GetPositions().Count()</p>
            </div>
            <div class="col-md-6 text-end">
                <span class="text-muted small text-uppercase">Total Select P/L (USD)</span>
                <h2 class="@(TotalPLUsd >= 0 ? "text-profit" : "text-loss") mb-0">
                    @TotalPLUsd.ToString("C2", CultureInfo.GetCultureInfo("en-US"))
                </h2>
            </div>
        </div>
    </div>

    <div class="filter-dashboard mb-3 p-3 shadow-sm bg-dark-header">
        <div class="d-flex justify-content-between align-items-end">
            <div class="account-filters">
                <span class="text-uppercase fw-bold x-small text-muted d-block mb-1">Accounts</span>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-dark btn-sm border-secondary active">Main Account</button>
                </div>
            </div>

            <div class="search-box mx-4" style="flex-grow: 1; max-width: 400px;">
                <label class="text-uppercase fw-bold x-small text-muted mb-1">Filter Accounts/Markets</label>
                <input type="text" class="form-control form-control-sm terminal-input"
                       placeholder="Type to filter..." @bind="_searchTerm" @bind:event="oninput" />
            </div>

            <div class="market-filters text-end">
                <span class="text-uppercase fw-bold x-small text-muted d-block mb-1">Top Markets</span>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => _searchTerm = ""'>All</button>
                    @foreach (var mkt in DynamicMarkets)
                    {
                        <button class="btn btn-outline-primary btn-sm @(_searchTerm == mkt ? "active" : "")"
                                @onclick="() => _searchTerm = mkt">
                            @mkt
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="trade-grid shadow-lg">
        <table class="table table-dark-custom mb-0">
            <thead>
                <tr>
                    <!-- FIRST COLUMN: ACCOUNT -->
                    <th>Account</th>

                    <!-- SECOND COLUMN: MARKET (moved here) -->
                    <th>Market</th>

                    <th>Direction</th>
                    <th class="text-end">Size</th>
                    <th class="text-end">Entry</th>
                    <th class="text-end">Ask / Bid</th>
                    <th class="text-end">Profit / Loss</th>
                    <th class="text-center">
                        Watch<br />
                        <input type="checkbox" @bind="SelectAll" class="trade-check-sm" />
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var pos in FilteredPositions)
                {
                    <tr>
                        <!-- ACCOUNT column: Broker + Account -->
                        <td class="align-middle">
                            <div class="fw-bold fs-6">@(!string.IsNullOrWhiteSpace(pos.Broker) ? pos.Broker : "—")</div>
                            <div class="text-muted x-small mono">@(!string.IsNullOrWhiteSpace(pos.Account) ? pos.Account : "—")</div>
                        </td>

                        <!-- MARKET column: readable market + position id -->
                        <td class="align-middle">
                            <div class="fw-bold fs-5">@GetMarketDisplay(pos.Symbol)</div>
                            <div class="text-muted x-small mono">@pos.Id</div>
                        </td>

                        <!-- DIRECTION -->
                        <td class="align-middle">
                            <span class="badge-custom @(pos.Type.Contains("BUY", StringComparison.OrdinalIgnoreCase) ? "side-buy" : "side-sell")">
                                @(!string.IsNullOrWhiteSpace(pos.Type) ? pos.Type.ToUpperInvariant() : "—")
                            </span>
                        </td>

                        <!-- SIZE -->
                        <td class="text-end align-middle fs-5 mono">@Math.Abs(pos.Size).ToString("F1")</td>

                        <!-- ENTRY -->
                        <td class="text-end align-middle fs-6 mono">@FormatPrice(pos.OpenLevel)</td>

                        <!-- ASK / BID + Spread -->
                        <td class="text-end align-middle">
                            <div class="mono fs-6">@FormatPrice(pos.Ask) / @FormatPrice(pos.Bid)</div>
                            <div class="d-flex flex-column">
                                <span class="x-small" style="font-size: 0.6rem; color: #5c636a;">
                                    Spread: @pos.SpreadPips.ToString("0.0") Pips
                                </span>
                            </div>
                        </td>

                        <!-- PROFIT / LOSS -->
                        <td class="pl-column">
                            <span class="pl-value @(pos.ProfitLoss >= 0 ? "text-success" : "text-danger")">
                                <span>@pos.CurrencySymbol @pos.ProfitLoss</span>
                                @* @GetFormattedPL(pos) *@
                            </span>
                        </td>

                        <!-- WATCH -->
                        <td class="text-center align-middle">
                            <input type="checkbox" @bind="pos.IsWatched" class="trade-check" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>