@page "/trade"
@using TVWeb.Models
@using TVWeb.Services
@using System.Linq
@inject PositionsStore Store
@implements IDisposable

<style>
    .trade-container {
        padding: 20px;
        font-family: sans-serif;
    }

    .trading-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

        .trading-table th {
            background: #333;
            color: #fff;
            padding: 12px;
            text-align: left;
        }

        .trading-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

    .mono {
        font-family: 'Consolas', monospace;
        text-align: right;
    }

    .pos {
        color: #27ae60;
        font-weight: bold;
    }

    .neg {
        color: #c0392b;
        font-weight: bold;
    }

    .buy-badge {
        background: #d4e6f1;
        color: #1a5276;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
    }

    .sell-badge {
        background: #fadbd8;
        color: #7b241c;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
    }

    .total-footer {
        background: #f4f4f4;
        font-weight: bold;
    }

    .trading-table {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #ccc;
    }

        .trading-table th {
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

    .total-footer td {
        padding: 15px 10px;
        border-top: 2px solid #333;
        font-size: 1.1rem;
    }

    .watch-cell {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* Custom checkbox size */
    input[type="checkbox"] {
        transform: scale(1.5);
        cursor: pointer;
    }
</style>

<div class="trade-container">
    <h3>Live Positions</h3>
    <table class="trading-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Side</th>
                <th class="mono">Bid</th>
                <th class="mono">Ask</th>
                <th class="mono">P/L</th>
                <th style="text-align:center">Watch</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var pos in Store.GetPositions())
            {
                <tr>
                    <td>@pos.Symbol</td>
                    <td><span class="@(pos.Type.Contains("BUY") ? "buy-badge" : "sell-badge")">@pos.Type</span></td>
                    <td class="mono">@pos.Bid.ToString("N5")</td>
                    <td class="mono">@pos.Ask.ToString("N5")</td>
                    <td class="mono @(pos.ProfitLoss >= 0 ? "pos" : "neg")">
                        @pos.ProfitLoss.ToString("N2")
                    </td>
                    <td style="text-align:center">
                        <input type="checkbox" @bind="pos.IsWatched" @bind:event="onchange" />
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr class="total-footer">
                <td colspan="4" style="text-align:right">Selected Total P/L:</td>
                <td class="mono @(TotalPL >= 0 ? "pos" : "neg")">@TotalPL.ToString("N2")</td>
                <td style="text-align:center">@WatchedCount</td>
            </tr>
        </tfoot>
    </table>
</div>

@code {
    private readonly PeriodicTimer _timer = new(TimeSpan.FromMilliseconds(500));
    private readonly CancellationTokenSource _cts = new();

    private decimal TotalPL => Store.GetPositions().Where(p => p.IsWatched).Sum(p => p.ProfitLoss);
    private int WatchedCount => Store.GetPositions().Count(p => p.IsWatched);

    protected override void OnInitialized() => _ = RefreshLoop();

    private async Task RefreshLoop()
    {
        try
        {
            while (await _timer.WaitForNextTickAsync(_cts.Token)) await InvokeAsync(StateHasChanged);
        }
        catch (OperationCanceledException) { }
    }

    public void Dispose() { _cts.Cancel(); _cts.Dispose(); _timer.Dispose(); }
}